import React from 'react';
import { View, StyleSheet } from 'react-native';
import MapView, { Marker, Polyline } from 'react-native-maps';

export default function MapComponent({ busLocations = [], userLocation, favStops = {}, GTFS_STOPS = {}, linesWithColors = {} }) {
  const defaultRegion = {
    latitude: 40.650002,
    longitude: -73.949997,
    latitudeDelta: 0.1,
    longitudeDelta: 0.1,
  };

  return (
    <View style={styles.container}>
      <MapView
        style={styles.map}
        initialRegion={userLocation ? {
          latitude: userLocation.latitude,
          longitude: userLocation.longitude,
          latitudeDelta: 0.05,
          longitudeDelta: 0.05,
        } : defaultRegion}
      >
        {/* Draw polylines for each line */}
        {Object.entries(linesWithColors).map(([line, color]) => {
          const stops = GTFS_STOPS[line];
          if (!stops || stops.length < 2) return null;
          const coordinates = stops.map(stop => ({
            latitude: stop.latitude,
            longitude: stop.longitude
          }));
          return (
            <Polyline
              key={`polyline-${line}`}
              coordinates={coordinates}
              strokeColor={color}
              strokeWidth={4}
            />
          );
        })}

        {/* User location marker */}
        {userLocation && (
          <Marker
            coordinate={{
              latitude: userLocation.latitude,
              longitude: userLocation.longitude,
            }}
            title="You"
            pinColor="blue"
          />
        )}

        {/* Bus markers */}
        {busLocations.map((bus, idx) => (
          <Marker
            key={bus.id || idx}
            coordinate={{
              latitude: bus.lat || bus.latitude,
              longitude: bus.lon || bus.longitude,
            }}
            title={`Bus ${bus.id || bus.label || ''}`}
            pinColor="red"
          />
        ))}
      </MapView>
    </View>
  );
}

const styles = StyleSheet.create({
  container: { flex: 1 },
  map: { ...StyleSheet.absoluteFillObject },
});